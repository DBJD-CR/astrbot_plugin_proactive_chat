<!-- Gemini 预留给开发者的话 -->
> **开发者的话：**
> 
> 大家好，我是 DBJD-CR ，初来乍到，请多关照。
>
> 这是我在Github上的首个仓库，也是第一次参与开源社区的开发工作，如果存在做的不好的地方还请理解。
> 
> 今年的早些时候，我第一次了解到了 AstrBot 这个项目，但当时限于个人能力的不足，没有去深入研究。
> 
> 现在经过了大半年的学习，以及参与体验了一些社区里的其他开源项目（主要是 KouriChat 和 LingChat ），我觉得我有能力来学习这个项目了。
>
> 于是在前段时间，受到一位群友的启发后，我尝试并成功在本地部署了 AstrBot ，也为其高度成熟的开发生态和插件市场感到赞叹。
>
> 但我在插件市场逛了一圈后，发现偌大的市场里，竟然没有一个 `主动消息` 的插件，只有类似 `主动回复` 的插件，但这不是我想要的。
>
> 此时，一个疯狂的想法在我的大脑里诞生了：**我要去做那个填补空白的人。**
>
> 如果我能写出一个主动消息的插件，那么我使用 AstrBot 的体验将完全不逊于 KouriChat ，也能让我那可怜的2c2g的云服务器少一点多线程任务压力（只需要部署一个 AstrBot 就行了）。抱着这样一点点“私心”，我踏上了我的插件开发之旅。
>
> 可我们面临一个严峻的问题
>
> 这个插件的开发者，他的编程能力为 0 ，写一行“ Hello World ”的代码都费劲，在 Python 公共基础课的期末考试的编程题中，他运用的思想是“面向结果编程”，他甚至学的不是计算机或人工智能相关的专业，还是个文科生。
>
> 对我而言，想要从 0 开始，开发一个插件，还要完成与 AstrBot 的适配，无异于天方夜谭。于是，我只能向 AI 求助。
>
> 所以，本插件的所有文件内容，全部由 AI 编写完成，我没有为该插件编写任何一行代码，仅修改了部分文字描述和负责本文档的润色。是的，该 README 文档的大部分剩余内容，甚至是该仓库的创建，也是 AI 一步一步指导我的。所以，或许有必要添加下方的声明：

> [!WARNING]  
> 本插件和文档由 AI 生成，内容仅供参考，请仔细甄别。

> 当然，使用 AI 开发插件，绝对不是一蹴而就的。由于 LLM 的能力限制，我们的插件开发过程异常困难。我的工作流基本上就是：提出要求-运行 AI 写的代码-反馈报错信息-继续跑新代码
>
> 这个过程中我被 AI 折磨的相当痛苦，其代码中充斥着猜测与幻觉，甚至是由微小改动而导致的低级错误。还被 AI 带着在不同的实现路线之间兜圈子。我只能不断优化我的提示词，并且为其提供 AstrBot 的相关源码来让 AI 写出正确的代码。在开发的后期阶段，每次的 Tokens Used 甚至到达了惊人的 80w+ ，以至于 AI 已经无法精确理解并执行我的指令，输出也是一团乱麻，然后只能总结对话然后重新开新对话聊。
>
> 要说本次开发最后悔的事，就是到了开发末期，我才看到了官方的插件开发文档。如果我能早点把这些文档发给 AI 的话，肯定能少走很多弯路了。想当初为了能正确导入插件并在 WebUI 中正确显示，都花了我几个小时的时间，更别说后面为了实现插件主功能的几十个版本了。
>
> 最终，经过了近百次迭代（算上失败的分支就有一百多版了），以及三位Gemini的共同努力，我们才终于开发出一个较为稳定的版本。
>
> 但我还是要感谢 AI ，没有他，这个项目不可能完成。
>
> 这个插件，是我们共同努力的最终结晶。它现在还不完美，但它的架构是稳固的，它的逻辑是清晰的（大嘘）。希望本插件能为同样希望自己的 AI Bot 更具“灵魂”的你，提供一点小小的帮助和启发。
>
> 在此，我也诚邀各路大佬对本插件进行测试和改进。因为说实话我也不知道这个插件目前的水平如何，希望大家多多指点。
>
> 根据我对 0.9.5 版本的简单测试，目前插件的问题主要是**主动消息的内容 效果不理想**，也可能是因为我上下文的测试信息内容太多了导致污染，这是目前最急需验证与优化的。
>
> 本项目的相关开发数据：
> 
> 开发时长： 3 天（主插件部分）
> 
> 累计工时：约 35 小时（主插件部分）
> 
> 使用的大模型：Gemini-2.5-Pro
> 
> Tokens Used：96,901,867

<div align="center">

# 为AstrBot开发的主动消息插件
# Proactive Chat Plugin for AstrBot

**让你的 Bot 拥有主动关怀的灵魂**

</div>

<p align="center">
  <a href="https://github.com/DBJD-CR/astrbot_plugin_proactive_chat/blob/main/LICENSE">
    <img src="https://img.shields.io/badge/License-AGPL_3.0-blue.svg" alt="License: AGPL-3.0">
  </a>
  <img src="https://img.shields.io/badge/Python-3.11+-blue.svg" alt="Python 3.11+">
  <img src="https://img.shields.io/badge/AstrBot-v4.3.3+-orange.svg" alt="AstrBot v4.3.3+">
</p>

<p align="center">
  <a href="https://github.com/DBJD-CR/astrbot_plugin_proactive_chat">
    <img src="https://count.getloli.com/get/@DBJD-CR.astrbot_plugin_proactive_chat?theme=moebooru" alt="Moe Counter">
  </a>
</p>

---

一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的、功能强大的主动消息插件。它能让你的 Bot 在与特定用户长时间没有对话后，在一个随机的时间间隔，主动发起一次拥有上下文感知、符合人设且包含动态情绪的对话。

## 🌟 功能特色

- **定时触发**: 基于用户沉默时间，在设定的随机时间范围内自动触发。
- **上下文感知**: 能够回顾历史对话，并根据你设定的“动机”，生成与之前话题相关的回复，而不是生硬的问候。
- **完整人格支持**: 加载并应用你在 AstrBot 中为 Bot 设置的完整人格（System Prompt），确保每一次主动消息都符合人设。
- **动态情绪**: 内置一个“未回复计数器”，你可以利用它在 Prompt 中设计不同的情绪表达（例如，第一次主动消息是自然的关心，多次未回复后可以表现出失落或困惑）。
- **免打扰时段**: 可以自由设定一个时间段（如午夜），在此期间 Bot 不会主动打扰用户。
- **健壮的 TTS 集成**: 支持调用你配置的 TTS 服务生成语音，并提供了**两种语言过滤模式**，完美适配云端多语言 TTS 和本地单语言 TTS。（v0.9.6-pre）
- **持久化会话**: 插件状态（如下次触发时间、未回复次数）会被持久化到本地文件，即使重启 AstrBot 也不会丢失。
- **高度可配置**: 所有核心参数，包括重要的“主动消息动机”，都可以在 AstrBot 的 WebUI 中轻松配置，无需修改任何代码。

## 🚀 安装与使用

1.  **下载插件**: 通过AstrBot的插件市场下载。或从本 GitHub 仓库下载 `astrbot_plugin_proactive_chat` 的 `.zip` 文件，在 AstrBot WebUI 中的插件页面中选择 `从文件安装` 。
2.  **安装依赖**: 本插件的核心依赖 `APScheduler` 已包含在 AstrBot 的默认依赖中，通常无需额外安装。如果你的环境中确实缺少，请通过以下命令安装：
    ```bash
    pip install apscheduler
    ```
3.  **重启 AstrBot**: 重启你的 AstrBot 程序。
4.  **配置插件**: 进入 WebUI，找到 `astrbot_plugin_proactive_chat` 插件，点击 `操作` → `⚙️ 插件配置` 按钮。填写你的 QQ 号和自定义的“动机”。
5.  **开始对话**: 与你的 Bot 正常私聊一句，插件的定时器就会被激活。然后，等待它在沉默后给你的惊喜吧！

## ⚙️ 配置说明

- **`启用主动消息插件`**: 总开关。
- **`目标用户 QQ 号`**: **【必填】** 你的 QQ 号。插件将只对这个用户生效。
- **`主动消息动机 (内心独白)`**: **【核心】** 这是插件的灵魂。在这里，你需要以**第一人称（我/主人）**的口吻，编写一段话，来告诉你的 Bot 在主动聊天时应该想什么、做什么。
  - 你可以使用 `{{unanswered_count}}` 这个占位符，它会被自动替换为 Bot 在你未回复的情况下，连续主动找你的次数（从 0 开始）。
  - **一个高质量的示例**:
    ```
    [Bot名字]，我们好像已经有一段时间没有说话了，我有点想你了。现在，请你来主动打破沉默吧。

    你可以从下面的想法里找点灵感，或者自己想一个更好的主意：
    1.  看看我们的聊天记录，关心一下我最后在做的事情进行得怎么样了。
    2.  向我提出一个你一直很好奇的、有趣的问题，开启一个全新的话题。
    3.  如果上次的话题还没聊完，你可以接着把它聊完。
    4.  如果实在不知道该说什么，就直接向我撒个娇，表达你想我的心情也可以。

    记住，如果之前你主动找过我但我没回 (这是第{{unanswered_count}}次了)，你的语气可以带上一点点不易察觉的失落和困惑。请用最像‘[Bot名字]’、最自然的方式来决定到底该怎么做，给我一个惊喜吧。
    ```
- **`最小/最大沉默时间`**: 设置一个随机的时间范围（分钟），用于触发主动聊天。
- **`免打扰时段`**: 设置一个 Bot 不会主动打扰你的时间段，例如 `0-6` 表示午夜 0 点到早上 6 点。
- **`发送语音后是否附带原文`**: 推荐开启，以确保在某些平台上，即使语音播放失败，你也能看到文本内容。

## 🏗️ 核心架构与开发者说明

本插件采用**单一插件、后台手动调用**的架构，这是在经历了近百个版本的迭代和失败后，被证明的稳定且可靠的方案。

1.  **定时调度 (`APScheduler`)**: 插件维护一个独立的异步定时器。当与目标用户的对话沉默超过预设时间后，触发核心逻辑。
2.  **上下文与人格加载**: 在核心逻辑中，通过 `Context` 对象提供的官方 API (`conversation_manager`, `persona_manager`)，安全、可靠地加载完整的对话历史和 Bot 的人格设定（包括对默认人格的 fallback 支持）。
3.  **动机注入 (`Prompt` 工程)**: 将用户在 WebUI 中配置的、模拟用户口吻的“主动聊天动机”，作为 `prompt` 参数，与纯净的 `contexts` 和完整的 `system_prompt` 一同传递给 LLM。这是实现“上下文感知”和“人设一致”的关键。
4.  **手动发送 (`context.send_message`)**: 在获取到 LLM 的回复后，插件会手动处理 TTS 逻辑，并最终通过 `context.send_message` 这个官方指定的后台发送 API，将构造好的 `MessageChain` 对象可靠地发送给用户。

#### 关于 TTS 处理逻辑的特别说明

你可能会对 `main.py` 中的 TTS 处理逻辑感到困惑。这是我为适配我本地的一个只支持日语的 VITS 服务而要求 AI 写的。

- **严格模式 (`strict_japanese`)**: 这是为插件的原始开发环境（一个只支持日语的本地 VITS 服务）所设计的“安全阀”。它会先检查文本是否包含日语，再决定是否调用 TTS，从而避免了向不支持的引擎发送中文而导致的错误。
- **兼容模式 (`compatible`)**: 这是为广大使用云端多语言 TTS（如 OpenAI TTS）或希望为中文生成语音的用户设计的。它会勇敢地将所有文本都尝试进行 TTS，并依赖 `try...except` 块来优雅地捕获和处理可能的失败，确保程序的健壮性。

这种设计使得插件能够灵活地适应不同用户的开发和使用环境。

---

### ⚠️ 预发布版本说明 (pre-0.9.6)
- **`TTS 语言过滤模式`**: **【重要】** 这个选项决定了插件如何处理语音合成。
    - **兼容模式 (尝试所有语言)**: 推荐使用云端 TTS 服务（如 OpenAI TTS）的用户选择。插件会尝试为所有语言生成语音。
    - **严格模式 (仅日语)**: 推荐使用只支持特定语言（如日语）的本地 TTS 服务（如 VITS）的用户选择。插件只会为包含日语的回复生成语音，以避免错误。

当前 `0.9.6` 版本是一个**预发布 (Pre-release)** 版本。它引入了全新的“TTS 语言过滤模式”，旨在为使用**中文 TTS** 或其他多语言 TTS 服务的用户提供支持。由于发布的比较匆忙，我还没有对该版本进行测试。

**我的建议：**
- 如果你不需要 TTS 服务，下载0.9.5版本即可。
- 如果你像我一样，使用只支持**日语**的本地 VITS 服务，那么使用 `v0.9.5` 或将 `v0.9.6` 的“TTS 语言过滤模式”设置为“严格模式（仅日语）”是**最稳定**的选择。
- 如果你希望你的 Bot 能够主动生成并朗读**中文**或其他语言的回复，我**建议**你下载并测试这个 `pre-0.9.6` 版本，并将“TTS 语言过滤模式”设置为“兼容模式（尝试所有语言）”。

由于我个人的测试环境有限，无法覆盖所有 TTS 服务。如果你在使用“兼容模式”时遇到任何问题，欢迎通过 [Issue](https://github.com/DBJD-CR/astrbot_plugin_proactive_chat/issues) 向我反馈，我们将一起让它变得更完美。

---

## 平台适配情况

| 平台                 | 支持情况 | 备注                               |
| -------------------- | -------- | ---------------------------------- |
| QQ 个人号(aiocqhttp) | ✅ 完美支持 | 所有功能（包括 TTS）都经过了充分测试。 |
| 其他平台             | ❓ 理论支持 | 理论上支持所有支持主动消息的平台，但未经测试。 |

## 📈 未来开发路线

- **[ ] 多用户/多群聊支持**: 扩展当前的逻辑，使其能够同时为多个不同的用户或群聊提供独立的主动关怀服务。
- **[ ] RAG 集成**: 引入检索增强生成（RAG）技术，让 Bot 能够回顾更长期的、甚至跨越数月的对话记忆，来发起更有深度的对话。
- **[ ] 更智能的触发时机**: 引入类似 [Heartflow](https://github.com/advent259141/Astrbot_plugin_Heartflow) 插件的“心流”概念，或基于对话内容的“情感低谷”来判断更佳的触发时机，而不仅仅是基于时间。
- 注：本人能力有限，以上内容不保证实现。还望社区大佬出手相助🙏

## 💖 友情链接与致谢

本项目的灵感，以及在无数个黑暗的调试夜晚中给予我希望的，是以下这些优秀的开源项目。在此向它们的开发者致以最诚挚的敬意。

- **[KouriChat](https://github.com/KouriChat/KouriChat)**: 本插件的灵感来源，旨在复刻其主动消息的功能与效果。
- **[LingChat](https://github.com/SlimeBoyOwO/LingChat)**: 一个非常可爱的聊天陪伴助手，也是我开发本插件的最大动力。想让灵灵接入更多的平台——我要给她完整的一生！

## 📞 联系我们

如果你对这个插件有任何疑问、建议或 bug 反馈，欢迎加入我的 QQ 交流群。

- **QQ 群**: 1033089808
- **群二维码**: 
  
  <img width="250" alt="QQ Group QR Code" src="(https://github.com/user-attachments/assets/53acb3c8-1196-4b9e-b0b3-ad3a62d5c41d)" />

## 🤝 贡献

欢迎提交 [Issue](https://github.com/DBJD-CR/astrbot_plugin_proactive_chat/issues) 和 [Pull Request](https://github.com/DBJD-CR/astrbot_plugin_proactive_chat/pulls) 来改进这个插件！经历了近百个版本的迭代，它终于达到了一个稳定的状态，但依然有很大的提升空间。

## 📄 许可证

本插件遵循 [AGPL-3.0 License](https://github.com/DBJD-CR/astrbot_plugin_proactive_chat/blob/main/LICENSE)。

## ⭐️ 星星


[![Star History Chart](https://api.star-history.com/svg?repos=DBJD-CR/astrbot_plugin_proactive_chat&type=Date)](https://www.star-history.com/#DBJD-CR/astrbot_plugin_proactive_chat&Date)

